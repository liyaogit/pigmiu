# 异地多活
## 分类
### 同城异区
搭建高速网络把两个地方连起来，达到近似本地机房的效果。架构上可以当做本地机房来设计。
### 跨城异区
需要数据传输，距离较远，网络传输延时，导致数据不一致问题。
### 跨国异区
延时时间更长，主要给不同地区的人提供服务，或者提供只读业务。对架构设计的要求不高。
> 亚马逊不同地区账号不能共用；Google不同地区搜索。

------------
## 设计技巧
### 保证核心业务异地多活
以用户系统举例：
* 注册问题：假设每个手机号只能注册一个用户，注册完服务器A宕机，用户到B进行注册，A恢复后数据同步。此时有两条注册数据，无解。

* 用户信息问题：异常情况下，在两台服务器更改信息，如何处理冲突？按时间戳有可能误差。
> 生成唯一递增ID可以解决，但生成系统也要考虑异地多活。

只保证核心功能登录异地多活即可。

### 保证核心数据的最终一致性
* 尽量减少机房距离，搭建告诉网络
* 尽量减少数据同步,只同步核心业务数据
> 例如session数据可以不同步
* 保证最终一致性，不保证实时一致性

### 采用多种手段同步数据
* 存储系统本身同步
> MySQL复制：单线程，网络抖动或者大量数据同步时，经常发生延时较长。
Redis复制：主从宕机后重连，触发全量主从复制。这是主机生成内存快照，继续服务。从机如果数据量大，恢复时间较长。

* 消息队列同步
> 对于账号数据，只创建不修改。可以用这种方式

* 二次读取方式
> A注册，访问B，消息同步延时，可以采用。第一次读取本地失败，第二次读取对端。

* 回源读取方式
> 对于session，数据量大，不采取同步。B拿到sessionId数据，根据路由判断，直接去A获取。
如果A宕机，B重新生成。

### 只保证大部分用户的异地多活
针对银行转账问题，无法做到实时的异地多活。只能通过特殊的业务手段保证异地多活。通过提供转账申请业务，A不转账，记录请求，发起异步到B，如果B不可用，则等待。牺牲一些用户体验,可通过成功后发短信通知改善。




